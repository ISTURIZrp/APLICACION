<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LabFlow Manager - Movimientos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        :root {
            --background-light: #ffffff;
            --background-medium: #f0f4f8;
            --background-dark: #e0e6ec;
            --text-primary: #2c3e50;
            --text-secondary: #607d8b;
            --border-color: #d1d9e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --accent-primary: #81d4fa;
            --accent-secondary: #4fc3f7;
            --action-success: #66bb6a;
            --action-error: #ef5350;
            --action-info: #42a5f5;
            --font-family: 'Plus Jakarta Sans', sans-serif;
            --sidebar-width-collapsed: 70px;
            --sidebar-width-expanded: 260px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-light); color: var(--text-primary); display: flex; min-height: 100vh; }
        main#content { flex-grow: 1; padding: 2rem 3rem; overflow-y: auto; height: 100vh; }
        .content-wrapper { background-color: var(--background-medium); border: 1px solid var(--border-color); border-radius: 16px; padding: 30px; box-shadow: 0 8px 25px var(--shadow-color); }
        .page-header { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; }
        .section-title { font-size: 1.6rem; font-weight: 700; margin-bottom: 25px; }
        .btn { font-family: var(--font-family); padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-dark); font-size: 1rem; transition: all 0.3s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-secondary); box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3); }
        #singleTransactionForm { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        #singleTransactionForm .full-width { grid-column: span 2; }
        .radio-group { display: flex; gap: 15px; align-items: center; }
        .error-message { color: var(--action-error); font-size: 0.85rem; margin-top: 5px; }
        table { width: 100%; margin-top: 30px; border-collapse: separate; border-spacing: 0; background: var(--background-medium); border-radius: 12px; overflow: hidden; }
        thead { background: var(--background-dark); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .transaction-type.entrada { color: var(--action-success); font-weight: 500; }
        .transaction-type.salida { color: var(--action-error); font-weight: 500; }
        .transaction-type.ajuste { color: var(--action-info); font-weight: 500; }
        .action-buttons { display: flex; gap: 8px; }
        .loading-message, .empty-message { text-align: center; padding: 1.5rem; color: var(--text-secondary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--background-light); padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
        #app-notification { position: fixed; top: 25px; right: 25px; padding: 12px 25px; border-radius: 8px; color: white; z-index: 2000; opacity: 0; transition: all 0.5s ease; transform: translateX(100%); }
        #app-notification.show { opacity: 1; transform: translateX(0); }
        #app-notification.success { background-color: var(--action-success); }
        #app-notification.error { background-color: var(--action-error); }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <main id="content">
        <header class="page-header">Gestión de Movimientos</header>
        
        <div class="content-wrapper">
            <h2 class="section-title">Registrar Movimiento</h2>
            <form id="singleTransactionForm" novalidate>
                <div class="form-group"><label for="insumoSelect">Insumo:</label><select id="insumoSelect" required disabled><option value="">Cargando...</option></select><div class="error-message" id="errorInsumo"></div></div>
                <div class="form-group"><label>Tipo:</label><div class="radio-group"><label><input type="radio" name="tipoTransaccion" value="entrada" required> Entrada</label><label><input type="radio" name="tipoTransaccion" value="salida"> Salida</label><label><input type="radio" name="tipoTransaccion" value="ajuste"> Ajuste</label></div><div class="error-message" id="errorTipo"></div></div>
                <div class="form-group" id="loteSelectGroup" style="display:none;"><label for="loteSelect">Lote (existente):</label><select id="loteSelect"></select><div id="loteStockInfo" style="font-size:0.85rem;margin-top:5px;"></div><div class="error-message" id="errorLote"></div></div>
                <div class="form-group" id="nuevoLoteGroup" style="display:none;"><label for="nuevoLoteInput">Nuevo Lote:</label><input type="text" id="nuevoLoteInput"><div class="error-message" id="errorNuevoLote"></div></div>
                <div class="form-group" id="fechaCaducidadNuevoLoteGroup" style="display:none;"><label for="fechaCaducidadNuevoLote">Caducidad Nuevo Lote:</label><input type="date" id="fechaCaducidadNuevoLote"><div class="error-message" id="errorFechaCaducidad"></div></div>
                <div class="form-group"><label for="cantidad">Cantidad:</label><input type="number" id="cantidad" min="1" required><div class="error-message" id="errorCantidad"></div></div>
                <div class="form-group full-width"><label for="comentarios">Comentarios:</label><textarea id="comentarios" rows="2" placeholder="Opcional"></textarea></div>
                <button type="submit" class="btn btn-primary" id="addToListBtn">Añadir a Lista</button>
            </form>

            <h2 class="section-title" style="margin-top:40px;">Pendientes de Confirmar</h2>
            <table id="pendingTransactionsTable">
                <thead><tr><th>Insumo</th><th>Lote</th><th>Tipo</th><th>Cantidad</th><th>Acciones</th></tr></thead>
                <tbody id="pendingTransactionsTableBody"></tbody>
            </table>
            <button class="btn btn-primary" id="confirmAllTransactionsBtn" style="margin-top:20px;" disabled>Confirmar Todo</button>

            <h2 class="section-title" style="margin-top:40px;">Historial</h2>
            <input type="search" id="historySearchInput" placeholder="Buscar en historial..." style="width:100%;max-width:450px;margin-bottom:1rem;">
            <table id="transactionsHistoryTable">
                <thead><tr><th>Fecha</th><th>Insumo</th><th>Lote</th><th>Tipo</th><th>Cantidad</th><th>Responsable</th><th>Acciones</th></tr></thead>
                <tbody id="transactionsHistoryTableBody"></tbody>
            </table>
            <div id="history-pagination-loading-message" class="loading-message" style="display:none;">Cargando más...</div>
        </div>
    </main>

    <div id="customConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar</h3><p id="modalMessage">¿Seguro?</p>
            <div class="modal-buttons">
                <button id="modalCancelBtn" class="btn">Cancelar</button>
                <button id="modalConfirmBtn" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="app-notification"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs, doc, getDoc, writeBatch, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCxJOpBEXZUo7WrAqDTrlJV_2kJBsL8Ym0",
            authDomain: "labflow-manager.firebaseapp.com",
            projectId: "labflow-manager",
            storageBucket: "labflow-manager.appspot.com",
            messagingSenderId: "742212306654",
            appId: "1:742212306654:web:a53bf890fc63cd5d05e44f"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA DEL SIDEBAR ---
        function initializeSidebar() {
            const userEmailDisplay = document.getElementById('user-email-display-sidebar');
            const logoutBtn = document.getElementById('user-logout-btn-sidebar');
            if (auth.currentUser && userEmailDisplay) { userEmailDisplay.textContent = auth.currentUser.email; }
            if (logoutBtn) { logoutBtn.addEventListener('click', () => signOut(auth)); }
            document.querySelectorAll('.menu-section-header').forEach(header => {
                header.addEventListener('click', () => {
                    const submenu = header.nextElementSibling;
                    const isVisible = submenu.style.display === 'block';
                    submenu.style.display = isVisible ? 'none' : 'block';
                });
            });
            const currentPage = window.location.pathname.split("/").pop() || "index.html";
            document.querySelectorAll('#sidebar a').forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                    const submenu = link.closest('.submenu');
                    if (submenu) submenu.style.display = 'block';
                }
            });
        }

        async function loadSidebar() {
            try {
                const response = await fetch('sidebar.html');
                if (!response.ok) throw new Error('Network response was not ok.');
                document.getElementById('sidebar-container').innerHTML = await response.text();
                initializeSidebar();
            } catch (error) {
                console.error("Failed to load sidebar:", error);
            }
        }

        // --- LÓGICA DE LA PÁGINA DE MOVIMIENTOS ---
        const insumoSelect = document.getElementById('insumoSelect');
        const loteSelect = document.getElementById('loteSelect');
        const loteSelectGroup = document.getElementById('loteSelectGroup');
        const nuevoLoteInput = document.getElementById('nuevoLoteInput');
        const nuevoLoteGroup = document.getElementById('nuevoLoteGroup');
        const fechaCaducidadNuevoLote = document.getElementById('fechaCaducidadNuevoLote');
        const fechaCaducidadNuevoLoteGroup = document.getElementById('fechaCaducidadNuevoLoteGroup');
        const cantidadInput = document.getElementById('cantidad');
        const singleTransactionForm = document.getElementById('singleTransactionForm');
        const pendingTransactionsTableBody = document.getElementById('pendingTransactionsTableBody');
        const confirmAllTransactionsBtn = document.getElementById('confirmAllTransactionsBtn');
        const transactionsHistoryTableBody = document.getElementById('transactionsHistoryTableBody');
        const loteStockInfo = document.getElementById('loteStockInfo');
        const historySearchInput = document.getElementById('historySearchInput');
        let pendingTransactions = [];
        let allInsumosCached = [];
        let currentUserEmail = null;
        let isAdmin = false;

        function showNotification(message, type = 'info') {
            const notificationDiv = document.getElementById('app-notification');
            notificationDiv.textContent = message;
            notificationDiv.className = type + ' show';
            setTimeout(() => { notificationDiv.classList.remove('show'); }, 3000);
        }

        async function loadInsumos() {
            try {
                const querySnapshot = await getDocs(collection(db, "insumos"));
                allInsumosCached = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                insumoSelect.innerHTML = '<option value="">Selecciona un insumo</option>';
                allInsumosCached.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(insumo => {
                    const option = new Option(insumo.nombre, insumo.id);
                    insumoSelect.add(option);
                });
                insumoSelect.disabled = false;
            } catch (error) {
                console.error("Error al cargar insumos:", error);
                showNotification('Error al cargar insumos.', 'error');
            }
        }

        async function populateLotes() {
            const insumoId = insumoSelect.value;
            loteSelect.innerHTML = '<option value="">Selecciona un lote</option>';
            loteStockInfo.textContent = '';
            if (!insumoId) return;

            const q = query(collection(db, "lotes"), where("insumo_id", "==", insumoId));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                const lote = doc.data();
                const option = new Option(`${lote.lote} (Stock: ${lote.existencia})`, doc.id);
                loteSelect.add(option);
            });
        }
        
        function handleTipoTransaccionChange() {
            const tipo = document.querySelector('input[name="tipoTransaccion"]:checked')?.value;
            loteSelectGroup.style.display = (tipo === 'salida' || tipo === 'ajuste' || tipo === 'entrada') ? 'block' : 'none';
            nuevoLoteGroup.style.display = (tipo === 'entrada') ? 'block' : 'none';
            fechaCaducidadNuevoLoteGroup.style.display = (tipo === 'entrada') ? 'block' : 'none';
        }
        
        function addTransactionToPendingList(e) {
            e.preventDefault();
            const insumoId = insumoSelect.value;
            const loteId = loteSelect.value;
            const tipo = document.querySelector('input[name="tipoTransaccion"]:checked')?.value;
            const cantidad = parseInt(cantidadInput.value, 10);
            
            if (!insumoId || !tipo || !cantidad) {
                showNotification('Completa todos los campos requeridos.', 'error');
                return;
            }

            const insumoNombre = allInsumosCached.find(i => i.id === insumoId)?.nombre;
            const loteNombre = loteId ? loteSelect.options[loteSelect.selectedIndex].text.split(' (')[0] : nuevoLoteInput.value.trim();

            pendingTransactions.push({
                insumoId, insumoNombre, loteId, loteNombre, tipo, cantidad,
                nuevoLote: nuevoLoteInput.value.trim(),
                fechaCaducidad: fechaCaducidadNuevoLote.value,
                comentarios: document.getElementById('comentarios').value.trim()
            });
            renderPendingTransactions();
            singleTransactionForm.reset();
        }
        
        function renderPendingTransactions() {
            pendingTransactionsTableBody.innerHTML = '';
            if (pendingTransactions.length === 0) {
                pendingTransactionsTableBody.innerHTML = '<tr><td colspan="5" class="empty-message">No hay movimientos pendientes</td></tr>';
                confirmAllTransactionsBtn.disabled = true;
                return;
            }
            confirmAllTransactionsBtn.disabled = false;
            pendingTransactions.forEach((tx, index) => {
                const row = `<tr>
                    <td>${tx.insumoNombre}</td>
                    <td>${tx.loteNombre}</td>
                    <td class="transaction-type ${tx.tipo}">${tx.tipo}</td>
                    <td>${tx.cantidad}</td>
                    <td class="action-buttons"><button class="btn-remove-pending" data-index="${index}">Eliminar</button></td>
                </tr>`;
                pendingTransactionsTableBody.innerHTML += row;
            });
        }
        
        async function confirmAllTransactions() {
             if (pendingTransactions.length === 0) return;
             const batch = writeBatch(db);

             for (const tx of pendingTransactions) {
                 const insumoRef = doc(db, "insumos", tx.insumoId);
                 let loteRef;
                 let currentStock = 0;

                 if (tx.tipo === 'entrada' && tx.nuevoLote) {
                     loteRef = doc(collection(db, "lotes"));
                     batch.set(loteRef, { insumo_id: tx.insumoId, lote: tx.nuevoLote, existencia: 0, fecha_caducidad: tx.fechaCaducidad });
                 } else {
                     loteRef = doc(db, "lotes", tx.loteId);
                     const loteSnap = await getDoc(loteRef);
                     if (loteSnap.exists()) currentStock = loteSnap.data().existencia;
                 }
                 
                 const newStock = tx.tipo === 'entrada' ? currentStock + tx.cantidad : currentStock - tx.cantidad;
                 if (newStock < 0) {
                     showNotification(`Stock insuficiente para ${tx.insumoNombre} - ${tx.loteNombre}.`, 'error');
                     return;
                 }
                 batch.update(loteRef, { existencia: newStock });

                 const transaccionRef = doc(collection(db, "transacciones"));
                 batch.set(transaccionRef, {
                     insumo_id: tx.insumoId, insumo_nombre: tx.insumoNombre, lote: tx.loteNombre, tipo: tx.tipo,
                     cantidad: tx.cantidad, fecha_transaccion: new Date().toISOString(), responsable: currentUserEmail,
                     comentarios: tx.comentarios
                 });
             }
             
             await batch.commit();
             showNotification('Movimientos confirmados.', 'success');
             pendingTransactions = [];
             renderPendingTransactions();
             loadTransactionsHistory(true);
        }
        
        async function loadTransactionsHistory(initial = false) {
             // Lógica para cargar el historial...
             transactionsHistoryTableBody.innerHTML = '<tr><td colspan="7" class="empty-message">No hay historial de movimientos.</td></tr>';
        }

        // --- EVENT LISTENERS ---
        insumoSelect.addEventListener('change', populateLotes);
        document.querySelectorAll('input[name="tipoTransaccion"]').forEach(radio => radio.addEventListener('change', handleTipoTransaccionChange));
        singleTransactionForm.addEventListener('submit', addTransactionToPendingList);
        confirmAllTransactionsBtn.addEventListener('click', confirmAllTransactions);
        pendingTransactionsTableBody.addEventListener('click', e => {
            if (e.target.classList.contains('btn-remove-pending')) {
                const index = e.target.dataset.index;
                pendingTransactions.splice(index, 1);
                renderPendingTransactions();
            }
        });

        // --- PUNTO DE ENTRADA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                await loadSidebar();
                await loadInsumos();
                await loadTransactionsHistory(true);
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>